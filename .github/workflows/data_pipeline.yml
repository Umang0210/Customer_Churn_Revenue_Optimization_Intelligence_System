name: CI Pipeline ‚Äì ML API

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Python 3.10 (stable + compatible with sklearn 1.3.2)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # 3Ô∏è‚É£ Upgrade pip
      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      # 4Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # 5Ô∏è‚É£ Sanity check: sklearn version
      - name: Run sanity checks
        run: |
          python - <<EOF
          import sklearn
          print("sklearn version:", sklearn.__version__)
          assert sklearn.__version__ == "1.3.2"
          EOF

      # 6Ô∏è‚É£ Build Docker image
      - name: Build Docker image
        run: |
          docker build -t churn-ml-api .

      # 7Ô∏è‚É£ Run container & test health endpoint
      - name: Run container & test health
        run: |
          docker run -d -p 8000:8000 --name churn-api-test churn-ml-api
          sleep 10
          curl --fail http://localhost:8000/health

      # 8Ô∏è‚É£ Test predict endpoint (valid payload)
      - name: Test predict endpoint (valid payload)
        run: |
          set -e

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8000/predict \
            -H "Content-Type: application/json" \
            -d '{
              "gender": "Female",
              "seniorcitizen": 0,
              "contract": "Month-to-month",
              "tenure": 12,
              "monthlycharges": 70.0,
              "totalcharges": 840.0
            }')

          BODY=$(echo "$RESPONSE" | head -n -1)
          STATUS=$(echo "$RESPONSE" | tail -n 1)

          echo "Status: $STATUS"
          echo "Body: $BODY"

          test "$STATUS" -eq 200
          echo "$BODY" | grep -E '"prediction"|\"churn\"' > /dev/null

      # 9Ô∏è‚É£ Test predict endpoint (invalid payload)
      - name: Test predict endpoint (invalid payload)
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/predict \
            -H "Content-Type: application/json" \
            -d '{}')

          echo "Invalid payload status: $STATUS"
          test "$STATUS" -eq 422

      # üîü Cleanup
      - name: Cleanup
        if: always()
        run: |
          docker stop churn-api-test || true
          docker rm churn-api-test || true
